```
title: ElasticSearch sharding work
description: ElasticSearch sharding work
created: 2018/03/05 12:12:13
post_name: elasticsearch-sharding-work
status: publish
tags: post, manager, readme, ElasticSearch, ES, sharding, indexes, indices, querying, fetching, indexing
layout: post
```

Wanted to share some insights my team has found with changing sharding strategies for ElasticSearch (ES).

Today we moved 100% of my work's search and autocomplete queries from a mutli-sharded index to a single-sharded index.

*Short version: Reducing shard count reduces system load, CPU usage, mostly positive results on performance.*

Medium version: In moving 100% of our searches and autocomplete queries from a mutli-sharded index to a single-sharded index, we saw drops in cluster load, queries generated by ES, and overall ES CPU usage.

<img class="small" style="padding-bottom: 10px" alt="Total Search Load" src="/images/posts/es-shard-1.png" />
<img class="small" style="padding-bottom: 10px" alt="Top CPU Load" src="/images/posts/es-shard-2.png" />
<img class="small" style="padding-bottom: 10px" alt="ElasticSearch Load" src="/images/posts/es-shard-3.png" />

We saw improvements in response time for retrieval and ranking from search.

<img class="small" style="padding-bottom: 10px" alt="Search Client" src="/images/posts/es-shard-4.png" />
<img class="small" style="padding-bottom: 10px" alt="Ranking Client" src="/images/posts/es-shard-5.png" />

Along with response time drops, we saw a smoothing of response times from search in general.

<img class="small" style="padding-bottom: 10px" alt="Search TP95" src="/images/posts/es-shard-6.png" />

Average query & fetch times increased. While we reduced the total number of queries ES generated, each of those queries and fetches was doing more work.

<img class="small" style="padding-bottom: 10px" alt="Fetch TP95" src="/images/posts/es-shard-7.png" />
<img class="small" style="padding-bottom: 10px" alt="Query TP95" src="/images/posts/es-shard-8.png" />

We managed to reduce response from search but autocomplete (which uses the same indice) saw its average response time increase. The response time is now much more stable, and the service performs better under high load. In the graph below, the red line is autocomplete with a single shard, the yellow line is the 5-shard autocomplete response time. As our load increased during the day today, you can see the 5-shard performance steadily decrease while the single shard response remained steady.

<img class="small" style="padding-bottom: 10px" alt="Autocomplete TP95" src="/images/posts/es-shard-9.png" />
